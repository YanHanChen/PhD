---
title: "A Quick Introduction to PhD via Examples"
author: "AAnne Chao, Yan-Han Chen and Chun-Huo Chiu"
output: rmarkdown::html_vignette
date: "`r Sys.Date()`"
vignette: >
  %\VignetteIndexEntry{A Quick Introduction to PhD via Examples}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE, warning=FALSE,}
knitr::opts_chunk$set(
  collapse = TRUE,
  warning = FALSE, message = FALSE,
  comment = ""
)
library(PhD)
#devtools::load_all(".")
library(ggplot2)
#library(kableExtra)
library(knitr)
data(data.abu)
data(data.inc)
```
`PhD` (**Ph**ylogenetic **D**iversity) is a R package providing the rarefaction/extrapolation and asymptotic estimation to achieve fair comparison of abundance-sensitive phylogenetic diversity among multiple assemblages (Hsieh and Chao, Systematic Biology, 2017). In this document, we provide a quick introduction demonstrating how to run `PhD`. The Detailed information about `PhD` functions is described in the `PhD` Manual, also available in [CRAN](https://cran.r-project.org/package=PhD). An online version of `PhDOnline` (<https://chao.shinyapps.io/PhDOnline/>) is developed for users without R background. The theoretical derivation of phylogenetic diversity measurements was proposed in Chao, A., Chiu C.-H. and Jost, L. (2010). `PhD` is an extension for [`iNextPD`](https://cran.r-project.org/package=iNextPD), which computes diversity estimates and its `conf` confidence intervals for the two types of rarefaction and extrapolation (R/E) based on two different sampling data sets, individual-based abundance data and quadrat-based incidence data.

Besides `iNEXTPD`, there are three main functions in `PhD`, including `PhdAsy`, `PhdObs` and `estimatePD`.

1. `iNEXTPD`: provides a seamless rarefaction and extrapolation sampling curve for Chao et al.’s (2010) phylogenetic diversity (PD) and mean phylogenetic diversity (meanPD). See Chao et al. (2010, 2015) and Hsieh and Chao (2017) for pertinent background and methods. It is the phylogenetic extension of `iNEXT` function in `iNEXT` package.

2. `PhdAsy`: computes asymptotic phylogenetic diversity estimates with respect to specified/default diversity order q and reference time reftime to infer true phylogenetic diversity (PD) or phylogenetic Hill numbers (meanPD). See Chao  et al. (2015) and Hsieh and Chao (2017) for the statistical estimation detail.

3. `PhdObs`: computes empirical (i.e., observed) phylogenetic diversity (PD) and phylogenetic Hill numbers (meanPD, mean phylogenetic diversity) for specified/default order q and reference time; see Chao et al. (2010) for details of PD and meanPD

4. `estimatePD`: computes Chao et al.’s (2010) phylogenetic diversity (PD, effective total branch lengths, for diversity order q = 0, 1 and 2) and mean phylogenetic diversity (meanPD, phylogenetic Hill numbers or the effective number of lineages, q = 0, 1 and 2) for given values of sample coverage. See Chao et al. (2010, 2015) and Hsieh and Chao (2017) for formulas and interpretations. It is the phylogenetic extension of `estimateD` in `iNEXT` package.


<br><font size="5">**SOFTWARE NEEDED TO RUN PhD IN R:**</font>
--------------------------------------

- Required: [R](https://cran.r-project.org/)
- Suggested: [RStudio IDE](https://www.rstudio.com/products/RStudio/#Desktop)

<br><font size="5">**HOW TO RUN PhD:**</font>
-------------------

The `PhD` package is available on [CRAN](https://cran.r-project.org/package=PhD) and can be downloaded with a standard R installation procedure using the following commands. Before installation, the additional visualization and computation extension packages (`chaoUtility`,`ape`, `dplyr`, `ggplot2`, `phyclust`, `Rcpp`) must be loaded. Please note that currently, package `chaoUtility` can only be available via github instead of CRAN and thus the installation procedure slightly differs from the one of standard R installation.

```{r eval=FALSE}
## install chaoUtility package from github
install.packages("devtools")
library(devtools)
install_github("chaolab2019/chaoUtility")

## install PhD package from CRAN
install.packages("PhD")

## Or instead, install the latest version from github
install_github("AnneChao/PhD")

## import packages
library(chaoUtility)
library(PhD)
```
<br><font size="5"><b>DATA FORMAT/INFORMATION</b></font> 
-------------------
In PhD package, all four main functions share the same required format of `data`. Two types data are supported.

1. Individual‐based abundance data (`datatype="abundance"`): species-by-site matrix/data.frame of species abundances. The row (species) names of data must match the species names in the phylogenetic tree and thus cannot be missing. Users can use the following command to see an example data containing three assemblages.

```{r eval=FALSE}
# include abundance data along with its phylogeny tree
data(data.abu)
```
```{r}
# view part of the species abundance
head(data.abu$data)
```

2. Sampling‐unit‐based incidence raw data (`datatype="incidence_raw"`): species-by-site raw incidence matrix/data.frame. When there are N assemblages and thus N matrices, users must first merge the N matrices by species identity to obtain a large merged incidence matrix, where the rows of the matrix refer to all species presented in the merged data. The row (species) names of data must match the species names in the phylogenetic tree and thus cannot be missing. Users can use the following command to see an example data containing two assemblages.

```{r eval=FALSE}
# include incidence raw data along with its phylogeny tree
data(data.inc)
```
```{r}
# an incidence matrix of 29 columns, where:
# the first assemblage consists of the first 12 columns (sampling units) and
# the second assemblage consists of the left 17 columns (sampling units).
# View part of the data
data.inc$data[1:6,1:12]
# the number of sampling units for two assemblages are 12 and 17, respectively.
data.inc$nT
```

<br><font size="5"><b>MAIN FUNCTIONS:</b></font>
-------------------

We describe the four main functions with default arguments below :

1. <u><font size="3">**iNEXTPD()**</u></font>:

```{r, eval=FALSE}
iNEXTPD(data, nT, datatype = "abundance",tree,q = c(0,1,2), reftime=NULL,type = "PD",
        endpoint = NULL, knots = 40, size = NULL, nboot = 50, conf = 0.95)
```
The arguments of this function are described below.

<table style="width:100%;">
<colgroup>
<col width="20%">
<col width="80%">
</colgroup>
<thead>
<tr>
<th align="center">Argument</th>
<th align="left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center"><code>data</code></td>
<td align="left"> a matrix/data.frame of species abundances or incidence matrix. See the <b>DATA FORMAT/INFORMATION</b> section above for detailed required format.</td>
</tr>
<tr>
<td align="center"><code>nT</code></td>
<td align="left"> needed only when `datatype = "incidence_raw"`, a sequence of named nonnegative integers specifying the number of sampling units in each assemblage. If `names(nT) = NULL`, automatically assigns "site1", "site2",..., as assemblage names. Ignored if `datatype = "abundance"`.</td>
</tr>
<tr>
<td align="center"><code>datatype</code></td>
<td align="left"> data type of input data: individual-based abundance data (`datatype = "abundance"`), or species-by-site raw incidence matrix (`datatype = "incidence_raw"`). Default is `"abundance"`</td>
</tr>
<tr>
<td align="center"><code>tree</code></td>
<td align="left"> a phylo object describing the phylogenetic tree in Newick format for all observed species in the pooled assemblage.</td>
</tr>
<tr>
<td align="center"><code>q</code></td>
<td align="left"> a nonnegative value or sequence specifying the diversity order. There are three measures: Faith's PD (`q = 0`), a simple transformation of phylogenetic entropy (`q = 1`) and a simple transformation of Rao's quadratic entropy (`q = 2`). Default is `c(0,1,2)`.</td>
</tr>
<tr>
<td align="center"><code>reftime</code></td>
<td align="left"> a positive value or sequence specifying the reference time for computing diversity. If `NULL`, `reftime` is set to be the tree depth of the phylogenetic tree spanned by the observed species in the pooled assemblage. Default is `NULL`.</td>
</tr>
<tr>
<td align="center"><code>type</code></td>
<td align="left"> desired diversity type: `type = "PD"` for Chao et al. (2010) phylogenetic diversity and `type = "meanPD"` for mean phylogenetic diversity (i.e., phylogenetic Hill number). Default is `"PD"`.</td>
</tr>
<tr>
<td align="center"><code>endpoints</code></td>
<td align="left"> a positive integer specifying the endpoint for rarefaction and extrapolation range. If `NULL`, then `endpoint =` double of the reference sample sizes. It is ignored if `size` is given.</td>
</tr>
<tr>
<td align="center"><code>knots</code></td>
<td align="left"> a positive integer specifying the number of equally-spaced knots between 1 and the `endpoint`. Default is 40.</td>
</tr>
<tr>
<td align="center"><code>size</code></td>
<td align="left"> a sequence of positive integers specifying the sample sizes for which PD or meanPD estimates will be calculated. If `NULL`, then estimates will be calculated for those sample sizes determined by the specified/default `endpoint` and `knots`.</td>
</tr>
<tr>
<td align="center"><code>nboot</code></td>
<td align="left"> a positive integer specifying the number of bootstrap replications in assessing sampling uncertainty and constructing confidence intervals. Enter 0 to skip the bootstrap procedures. Default is 50.</td>
</tr>
<tr>
<td align="center"><code>conf</code></td>
<td align="left"> a positive number < 1 specifying the level of confidence interval. Default is 0.95.</td>
</tr>

</tbody>
</table>

<br>

The sequence of sample sizes for which PD/meanPD R/E curve will be estimated is determined by `endpoint`, `knots` and `size`.
If `size` is specified by users, then PD/meanPD will be estimated for these sizes plus the reference sample size(total species abundances for abundance data; total sampling units for incidence data). 
If `knots=K`, then the sequece would be K/2 evenly‐spaced knots (sample sizes) before reference sample size and K/2 from reference sample size to `endpoint`, where the `endpoint` is default to double reference sample size. By default, `knots=40`.
If `endpoint` specified by users is smaller than the reference sample size, `iNEXTPD` only computes rarefaction estimates for approximately `knots` evenly spaced knots before the `endpoint`.


2. <u><font size="3">**PhdAsy()**</u></font>:

```{r, eval=FALSE}
PhdAsy(data, nT, datatype = "abundance", tree, q = seq(0, 2, by = 0.25), 
       reftime = NULL, type = "PD", nboot = 50, conf = 0.95)
```

The arguments of this function are described below.

<table style="width:100%;">
<colgroup>
<col width="20%">
<col width="80%">
</colgroup>
<thead>
<tr>
<th align="center">Argument</th>
<th align="left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center"><code>data</code></td>
<td align="left"> a matrix/data.frame of species abundances (for abundance data) or species-by-site raw incidence matrix (for incidence data). See the <b>DATA FORMAT/INFORMATION</b> section above for detailed required format.</td>
</tr>
<tr>
<td align="center"><code>nT</code></td>
<td align="left"> needed only when `datatype = "incidence_raw"`, a sequence of named nonnegative integers specifying the number of sampling units in each assemblage. If `names(nT) = NULL`, automatically assigns "site1", "site2",..., as assemblage names. Ignored if `datatype = "abundance"`.</td>
</tr>
<tr>
<td align="center"><code>datatype</code></td>
<td align="left"> data type of input data: individual-based abundance data (`datatype = "abundance"`), or species-by-site raw incidence matrix (`datatype = "incidence_raw"`). Default is `"abundance"`</td>
</tr>
<tr>
<td align="center"><code>tree</code></td>
<td align="left"> a phylo object describing the phylogenetic tree in Newick format for all observed species in the pooled assemblage.</td>
</tr>
<tr>
<td align="center"><code>q</code></td>
<td align="left"> a nonnegative value or sequence specifying the diversity order. Default is `seq(0, 2, by = 0.25)`.</td>
</tr>
<tr>
<td align="center"><code>reftime</code></td>
<td align="left"> a positive value or sequence specifying the reference time for computing diversity. If `NULL`, `reftime` is set to be the tree depth of the phylogenetic tree spanned by the observed species in the pooled assemblage. Default is `NULL`.</td>
</tr>
<tr>
<td align="center"><code>type</code></td>
<td align="left"> desired diversity type: `type = "PD"` for Chao et al. (2010) phylogenetic diversity and `type = "meanPD"` for mean phylogenetic diversity (i.e., phylogenetic Hill number). Default is `"PD"`.</td>
</tr>
<tr>
<td align="center"><code>nboot</code></td>
<td align="left"> a positive integer specifying the number of bootstrap replications in assessing sampling uncertainty and constructing confidence intervals. Enter 0 to skip the bootstrap procedures. Default is 50.</td>
</tr>
<tr>
<td align="center"><code>conf</code></td>
<td align="left"> a positive number < 1 specifying the level of confidence interval. Default is 0.95.</td>
</tr>

</tbody>
</table>

<br>

3. <u><font size="3">**PhdObs()**</u></font>:

```{r, eval=FALSE}
PhdObs(data, nT, datatype = "abundance", tree, q = seq(0, 2, by = 0.25),
       reftime = NULL, type = "PD", nboot = 50, conf = 0.95)
```

The arguments of this function are described below.

<table style="width:100%;">
<colgroup>
<col width="20%">
<col width="80%">
</colgroup>
<thead>
<tr>
<th align="center">Argument</th>
<th align="left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center"><code>data</code></td>
<td align="left"> a matrix/data.frame of species abundances (for abundance data) or species-by-site raw incidence matrix (for incidence data). See the <b>DATA FORMAT/INFORMATION</b> section above for detailed required format.</td>
</tr>
<tr>
<td align="center"><code>nT</code></td>
<td align="left"> needed only when `datatype = "incidence_raw"`, a sequence of named nonnegative integers specifying the number of sampling units in each assemblage. If `names(nT) = NULL`, automatically assigns "site1", "site2",..., as assemblage names. Ignored if `datatype = "abundance"`.</td>
</tr>
<tr>
<td align="center"><code>datatype</code></td>
<td align="left"> data type of input data: individual-based abundance data (`datatype = "abundance"`), or species-by-site raw incidence matrix (`datatype = "incidence_raw"`). Default is `"abundance"`</td>
</tr>
<tr>
<td align="center"><code>tree</code></td>
<td align="left"> a phylo object describing the phylogenetic tree in Newick format for all observed species in the pooled assemblage.</td>
</tr>
<tr>
<td align="center"><code>q</code></td>
<td align="left"> a nonnegative value or sequence specifying the diversity order. Default is `seq(0, 2, by = 0.25)`.</td>
</tr>
<tr>
<td align="center"><code>reftime</code></td>
<td align="left"> a positive value or sequence specifying the reference time for computing diversity. If `NULL`, `reftime` is set to be the tree depth of the phylogenetic tree spanned by the observed species in the pooled assemblage. Default is `NULL`.</td>
</tr>
<tr>
<td align="center"><code>type</code></td>
<td align="left"> desired diversity type: `type = "PD"` for Chao et al. (2010) phylogenetic diversity and `type = "meanPD"` for mean phylogenetic diversity (i.e., phylogenetic Hill number). Default is `"PD"`.</td>
</tr>
<tr>
<td align="center"><code>nboot</code></td>
<td align="left"> a positive integer specifying the number of bootstrap replications in assessing sampling uncertainty and constructing confidence intervals. Enter 0 to skip the bootstrap procedures. Default is 50.</td>
</tr>
<tr>
<td align="center"><code>conf</code></td>
<td align="left"> a positive number < 1 specifying the level of confidence interval. Default is 0.95.</td>
</tr>


</tbody>
</table>

4. <u><font size="3">**estimatePD()**</u></font>:

```{r, eval=FALSE}
estimatePD <- function(data,nT,datatype = "abundance", tree, q = c(0,1,2), reftime=NULL,
                       type = "PD", level = NULL, nboot = 50, conf = 0.95)
```

The arguments of this function are described below.

<table style="width:100%;">
<colgroup>
<col width="20%">
<col width="80%">
</colgroup>
<thead>
<tr>
<th align="center">Argument</th>
<th align="left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center"><code>data</code></td>
<td align="left"> a matrix/data.frame of species abundances (for abundance data) or species-by-site raw incidence matrix (for incidence data). See the <b>DATA FORMAT/INFORMATION</b> section above for detailed required format.</td>
</tr>
<tr>
<td align="center"><code>nT</code></td>
<td align="left"> needed only when `datatype = "incidence_raw"`, a sequence of named nonnegative integers specifying the number of sampling units in each assemblage. If `names(nT) = NULL`, automatically assigns "site1", "site2",..., as assemblage names. Ignored if `datatype = "abundance"`.</td>
</tr>
<tr>
<td align="center"><code>datatype</code></td>
<td align="left"> data type of input data: individual-based abundance data (`datatype = "abundance"`), or species-by-site raw incidence matrix (`datatype = "incidence_raw"`). Default is `"abundance"`.</td>
</tr>
<tr>
<td align="center"><code>tree</code></td>
<td align="left"> a phylo object describing the phylogenetic tree in Newick format for all observed species in the pooled assemblage.</td>
</tr>
<tr>
<td align="center"><code>q</code></td>
<td align="left"> a nonnegative value or sequence specifying the diversity order. Default is `c(0,1,2)`.</td>
</tr>
<tr>
<td align="center"><code>reftime</code></td>
<td align="left"> a positive value or sequence specifying the reference time for computing diversity. If `NULL`, `reftime` is set to be the tree depth of the phylogenetic tree spanned by the observed species in the pooled assemblage. Default is `NULL`.</td>
</tr>
<tr>
<td align="center"><code>type</code></td>
<td align="left"> desired diversity type: `type = "PD"` for Chao et al. (2010) phylogenetic diversity and `type = "meanPD"` for mean phylogenetic diversity (i.e., phylogenetic Hill number). Default is `"PD"`.</td>
</tr>
<tr>
<td align="center"><code>level</code></td>
<td align="left"> a positive value or sequence < 1 specifying a particular value of sample coverage. If `NULL`,then `level` will be chosen as the minimum coverage of all sites after extrapolating each site to its double sample sizes. Default is `NULL`.</td>
</tr>
<tr>
<td align="center"><code>nboot</code></td>
<td align="left"> a positive integer specifying the number of bootstrap replications in assessing sampling uncertainty and constructing confidence intervals. Enter 0 to skip the bootstrap procedures. Default is 50.</td>
</tr>
<tr>
<td align="center"><code>conf</code></td>
<td align="left"> a positive number < 1 specifying the level of confidence interval. Default is 0.95.</td>
</tr>


</tbody>
</table>

<br>


<br>


<br><font size="5"><b>PhD VIA EXAMPLES: Abundance data</b></font>
-------------------

Here, we use an abundance demo data as an illustrating example. If `datatype = "incidence_raw"`, slight modification of argument setting is needed; see the description of four main functions for detail. Some argument setting and output for incidence data also will be explained in later text.

Plants phylogeny and survey dataset is included in `PhD` package (`data(data.abu)`). The phylogeny tree (<code>\$tree</code>) of 46 plant species in this data set is constructed by the website phylomatic (http://phylodiversity.net/phylomatic/). This data includes three types of dunes habitats: emboryo dunes (ED), mobile dunes (MD) and transtion dunes (TD), which contains 17, 39, 42 distinct plants respectively. 
Throughout the illustration, we will not specify the argument `reftime` so that it is automatically fixed at 325, which is the tree depth of the pooled assemblage, by default.

To demonstrate this data, the following commands display basic data visualization:

```{r, echo=FALSE, results='hide', warning=FALSE, message=FALSE}
library(ade4)
library(ape)
library(dplyr)
```

```{r, fig.width=7, fig.height=7, fig.align="center"}
data(data.abu)
str(data.abu)
table.phylog(data.abu$data, ade4::newick2phylog(ape::write.tree(data.abu$tree)), 
             csize=4, f.phylog=0.7, clabel.row = .81)
```

Also, `PDInfo` summarizes some phylogenetic statistics for each assemblage, including reference sample size (`n`), number of observed species (`S.obs`), observed branch length, i.e., Faith’s PD (`PD.obs`), the first two rare species frequency counts and their branch length sums, at specified/default reference time specified in the argument `reftime`.

```{r,}
# leave argument "reftime" unsecified and it will be defaulted to the tree depth. 
PD_stat <- PDInfo(data = data.abu$data, tree = data.abu$tree, datatype = "abundance")
kable(PD_stat)
```

We now apply four main functions to the abundance data to see the outputs:

### 1. `iNEXTPD()`: 

```{r,}
dunes_iNEXT <- iNEXTPD(data = data.abu$data, tree = data.abu$tree, datatype = "abundance")
```

`iNEXTPD()` returns two tables:

* `$size_based`: size-based PD or meanPD estimates along with their confidence intervals (if `nboot > 0`} and related statistics.
* `$coverage_based`: coverage-based diversity estimates along with confidence intervals and related statistics. 

```{r, eval=FALSE}
# only show part of the table, call View(dunes_iNEXT$size_based) to see full table.
dunes_iNEXT$size_based
```

```{r, echo=FALSE,warning=FALSE}
y <- dunes_iNEXT$size_based
Assemblages <- unique(y$Assemblage)
tmp <- lapply(1:length(Assemblages),function(i){
        y_each <- subset(y, Assemblage==Assemblages[i])
        m_qt <- quantile(unlist(y_each$m), type = 1)
        filter(y_each, m %in% m_qt)
      })     
kable(do.call(rbind,tmp))
```

```{r, eval=FALSE}
# only show part of the table, call View(dunes_iNEXT$coverage_based) to see full table.
dunes_iNEXT$coverage_based
```

```{r, echo=FALSE,warning=FALSE}
y <- dunes_iNEXT$coverage_based
Assemblages <- unique(y$Assemblage)
tmp <- lapply(1:length(Assemblages),function(i){
        y_each <- subset(y, Assemblage==Assemblages[i])
        m_qt <- quantile(unlist(y_each$m), type = 1)
        filter(y_each, m %in% m_qt)
      })     
kable(do.call(rbind,tmp))
```

To visualize the curves, use `ggiNEXTPD` to obtain plots based on `ggplot2` package. This function provides three types of curves, which can be specified in the argument `plot.type`: 
 
1. Sample-size-based rarefaction and extrapolation curve (`plot.type = 1`): sampling curve depicting phylogenetic diversity estimates as a function of sample size.
2. Sample completeness curve (`plot.type = 2`): the curve of sample coverage as a function of sample size.
3. Coverage-based R/E curve (`plot.type = 3`): sampling curve depicting phylogenetic diversity estimates as a function of sample coverage.



```{r, eval= FALSE}
# plot.type = 1
ggiNEXTPD(dunes_iNEXT, plot.type = 1)$RE.plot.size
```

```{r,echo = FALSE ,fig.width=7, fig.height=7, fig.align="center",warning=FALSE}
# plot.type = 1
ggiNEXTPD(dunes_iNEXT,plot.type = 1)$RE.plot.size + theme(text=element_text(size=14))
```

```{r, eval= FALSE}
# plot.type = 2
ggiNEXTPD(dunes_iNEXT, plot.type = 2)$RE.plot.sizeC
```

```{r,echo = FALSE ,fig.width=7, fig.height=7, fig.align="center"}
ggiNEXTPD(dunes_iNEXT,plot.type = 2)$RE.plot.sizeC + theme(text=element_text(size=14))
```

```{r, eval= FALSE}
# plot.type = 3
ggiNEXTPD(dunes_iNEXT, plot.type = 3)$RE.plot.C
```

```{r,echo = FALSE ,fig.width=7, fig.height=7, fig.align="center"}
ggiNEXTPD(dunes_iNEXT,plot.type = 3)$RE.plot.C + theme(text=element_text(size=14))
```


### 2. `PhdAsy()`

```{r,}
# leave argument "reftime" unsecified and it will be defaulted to the tree depth. 
dunes_Asy <- PhdAsy(data = data.abu$data, datatype = "abundance", 
                    tree = data.abu$tree, q = seq(0, 2, by = 0.25))
```

`PhdAsy()` function returns a table of estimated asymptotic phylogenetic diversity(`type = "PD"`) or phylogenetic Hill number(`type = "meanD"`)  with respect to specified/default order `q` and reference time `reftime`. It is based on statistical estimation of the unknown true PD or meanD; see Chao et al. (2015) and Hsieh and Chao (2017) for the statistical estimation detail.

```{r,}
# only show estimate for q = 0, 1, 2, call View(dunes_Asy) to see full table.
kable(dunes_Asy %>% filter(Order.q %in% c(0,1,2)))
```

To visualize the curves, use `ggtqplotPD` to obtain plots based on `ggplot2` package. This function provides two types of curves: order `q` profile or reference `time` profile, which can be specified in the argument `profile`.

```{r, eval= FALSE}
ggtqplotPD(dunes_Asy, profile = "q")
```

```{r,echo = FALSE, fig.width=7, fig.height=7, fig.align="center"}
ggtqplotPD(dunes_Asy,profile = "q") + theme(text=element_text(size=14))
```

### 3. `PhdObs()`

For `PhdObs`, we demonstrate both observed order `q` profile and reference time profile of PD (`type = "PD"`). 

First, observed order `q` profile of PD for `reftime` fixed at tree depth:

```{r,}
# leave argument "reftime" unsecified and it will be defaulted to the tree depth. 
dunes_Obs_q <- PhdObs(data = data.abu$data, datatype = "abundance", tree = data.abu$tree, 
                    q = seq(0, 2, by = 0.2),type = "PD")
```

`PhdObs` function returns a table of empirical (observed) phylogenetic diversity(`type = "PD"`) or phylogenetic Hill number(`type = "meanPD"`) with respect to specified/default order `q` and reference time `reftime`.

```{r,}
# only show estimate for q = 0, 1, 2, call View(dunes_Obs_q) to see full table.
kable(dunes_Obs_q %>% filter(Order.q %in% c(0,1,2)))
```

To visualize the curves, use `ggtqplotPD` to obtain plots based on `ggplot2` package. This function provides two types of curves: order `q` profile or reference `time` profile, which can be specified in the argument `profile`.

```{r, eval= FALSE}
ggtqplotPD(dunes_Obs_q, profile = "q")
```

```{r,echo = FALSE, fig.width=7, fig.height=7, fig.align="center"}
ggtqplotPD(dunes_Obs_q,profile = "q") + theme(text=element_text(size=14))
```

Second, observed reference time profile of PD for different diversity order `q`:

```{r,}
dunes_Obs_time <- PhdObs(data = data.abu$data, datatype = "abundance", tree = data.abu$tree, 
                    q = c(0,1,2),reftime = seq(0.01,325,length.out = 40),type = "PD")

# only show part of the table, call View(dunes_iNEXT) to see full table.
kable(head(dunes_Obs_time))
```

To visualize the curves, use `profile = "time"` in `ggtqplotPD`.

```{r, eval= FALSE}
ggtqplotPD(dunes_Obs_time, profile = "time")
```

```{r,echo = FALSE, fig.width=7, fig.height=7, fig.align="center"}
ggtqplotPD(dunes_Obs_time,profile = "time") + theme(text=element_text(size=14))
```

### 4. `estimatePD()`

```{r,}
# leave argument "reftime" unsecified and it will be defaulted to the tree depth.
dunes_estPD <- estimatePD(data = data.abu$data, datatype = "abundance",
                          tree = data.abu$tree, q = c(0,1,2),level = 0.9)
```

The `estimatePD()` function returns a table of the computed phylogenetic diversity (PD or meanPD) for specified/default diversity orders `q` and reference times for the user-specified values of sample coverage. The corresponding sample sizes and sample coverage values are also provided.

```{r,}
kable(dunes_estPD)
```

<br><font size="5"><b>PhD VIA EXAMPLES: Incidence data</b></font>
-------------------

For incidence data (`datatype="incidence_raw"`), all four main functions in `PhD` can only accept incidence raw data (a species-by-site matrix consisting of 0 and 1). 
Also, different from abundance data, users have to specify a sequence `nT` of N positve integer describing the number of sampling units for each of N assemblages. See the <b>DATA FORMAT/INFORMATION</b> section above for detailed required format.

Bird phylogeny and survey incidence dataset is included in `PhD` package (`data(data.inc)`). This data set describes the phylogeny (`$tree`) of 41 birds as reported by Jetz et al. (2012). It also gives the two sites (North.site and South.site) of species incidence (`$data`) data to these 41 species in November 2012 at Barrington Tops National Park, Australia. In `$data` matrix, the first 12 columns (sampling units) belongs to North.site and the left 17 columns (sampling units) belongs to South.site, which is described in `$nT`.

Here, the procedures of applying four main functions to incidence data is similar to those for abundance case and so are their outcomes.

`PDInfo` summarizes some phylogenetic statistics for each assemblage, including number of sampling units (`nT`), number of observed species (`S.obs`), observed branch length, i.e., Faith’s PD (`PD.obs`), the first two rare species frequency counts and their branch length sums, at specified/default reference time specified in the argument `reftime`.

```{r,warning=FALSE}
# leave argument "reftime" unsecified and it will be defaulted to the tree depth. 
PD_stat <- PDInfo(data = data.inc$data, nT = data.inc$nT,datatype = "incidence_raw",tree = data.inc$tree)
kable(PD_stat)
```

We now apply four main functions to the incidence raw data to see the outputs:

### 1. `iNEXTPD()`: 

```{r,}
birds_iNEXT <- iNEXTPD(data = data.inc$data, nT = data.inc$nT, datatype = "incidence_raw",
                       tree = data.inc$tree)
```

`iNEXTPD()` returns two tables:
* `$size_based`: size-based PD or meanPD estimates along with their confidence intervals (if `nboot > 0`} and related statistics. \cr
* `$coverage_based`: coverage-based diversity estimates along with confidence intervals and related statistics. 

```{r, eval=FALSE}
# only show part of the table, call View(birds_iNEXT$size_based) to see full table.
birds_iNEXT$size_based
```

```{r, echo=FALSE,warning=FALSE}
y <- birds_iNEXT$size_based
Assemblages <- unique(y$Assemblage)
tmp <- lapply(1:length(Assemblages),function(i){
        y_each <- subset(y, Assemblage==Assemblages[i])
        m_qt <- quantile(unlist(y_each$nt), type = 1)
        filter(y_each, nt %in% m_qt)
      })     
kable(do.call(rbind,tmp))
```

```{r, eval=FALSE}
# only show part of the table, call View(birds_iNEXT$coverage_based) to see full table.
birds_iNEXT$coverage_based
```

```{r, echo=FALSE,warning=FALSE}
y <- birds_iNEXT$coverage_based
Assemblages <- unique(y$Assemblage)
tmp <- lapply(1:length(Assemblages),function(i){
        y_each <- subset(y, Assemblage==Assemblages[i])
        m_qt <- quantile(unlist(y_each$nt), type = 1)
        filter(y_each, nt %in% m_qt)
      })     
kable(do.call(rbind,tmp))
```

To visualize the curves, use `ggiNEXTPD` to obtain plots based on `ggplot2` package. This function provides three types of curves, which can be specified in the argument `plot.type`: 
 
1. Sample-size-based rarefaction and extrapolation curve (`plot.type = 1`): sampling curve depicting phylogenetic diversity estimates as a function of sample size.
2. Sample completeness curve (`plot.type = 2`): the curve of sample coverage as a function of sample size.
3. Coverage-based R/E curve (`plot.type = 3`): sampling curve depicting phylogenetic diversity estimates as a function of sample coverage.

```{r, eval= FALSE}
# plot.type = 1
ggiNEXTPD(birds_iNEXT, plot.type = 1)$RE.plot.size
```

```{r,echo = FALSE ,fig.width=7, fig.height=7, fig.align="center",warning=FALSE}
# plot.type = 1
ggiNEXTPD(birds_iNEXT,plot.type = 1)$RE.plot.size + theme(text=element_text(size=14))
```

```{r, eval= FALSE}
# plot.type = 2
ggiNEXTPD(birds_iNEXT, plot.type = 2)$RE.plot.sizeC
```

```{r,echo = FALSE ,fig.width=7, fig.height=7, fig.align="center",warning=FALSE}
ggiNEXTPD(birds_iNEXT,plot.type = 2)$RE.plot.sizeC + theme(text=element_text(size=14))
```

```{r, eval= FALSE}
# plot.type = 3
ggiNEXTPD(birds_iNEXT, plot.type = 3)$RE.plot.C
```

```{r,echo = FALSE ,fig.width=7, fig.height=7, fig.align="center",warning=FALSE}
ggiNEXTPD(birds_iNEXT,plot.type = 3)$RE.plot.C + theme(text=element_text(size=14))
```

### 2. `PhdAsy()`

```{r,warning=FALSE}
# leave argument "reftime" unsecified and it will be defaulted to the tree depth. 
birds_Asy <- PhdAsy(data = data.inc$data, datatype = "incidence_raw", nT = data.inc$nT,
                    tree = data.inc$tree, q = seq(0, 2, by = 0.2))
```

`PhdAsy()` function returns a table of estimated asymptotic phylogenetic diversity(`type = "PD"`) or phylogenetic Hill number(`type = "meanD"`)  with respect to specified/default order `q` and reference time `reftime`. It is based on statistical estimation of the unknown true PD or meanD; see Chao et al. (2015) and Hsieh and Chao (2017) for the statistical estimation detail.

```{r,}
# only show estimate for q = 0, 1, 2, call View(birds_Asy) to see full table.
kable(birds_Asy %>% filter(Order.q %in% c(0,1,2)))
```

To visualize the curves, use `ggtqplotPD` to obtain plots based on `ggplot2` package. This function provides two types of curves: order `q` profile or reference `time` profile, which can be specified in the argument `profile`.

```{r, eval= FALSE}
ggtqplotPD(birds_Asy, profile = "q")
```

```{r,echo = FALSE, fig.width=7, fig.height=7, fig.align="center"}
ggtqplotPD(birds_Asy,profile = "q") + theme(text=element_text(size=14))
```

### 3. `PhdObs()`

For `PhdObs`, we demonstrate both observed order `q` profile and reference time profile of PD (`type = "PD"`). 

First, observed order `q` profile of PD for `reftime` fixed at tree depth:

```{r,}
# leave argument "reftime" unsecified and it will be defaulted to the tree depth. 
birds_Obs_q <- PhdObs(data = data.inc$data, nT = data.inc$nT, datatype = "incidence_raw",
                      tree = data.inc$tree, q = seq(0, 2, by = 0.2),type = "PD")
```

`PhdObs` function returns a table of empirical (observed) phylogenetic diversity(`type = "PD"`) or phylogenetic Hill number(`type = "meanPD"`) with respect to specified/default order `q` and reference time `reftime`.

```{r,}
# only show estimate for q = 0, 1, 2, call View(birds_Obs_q) to see full table.
kable(birds_Obs_q %>% filter(Order.q %in% c(0,1,2)))
```

To visualize the curves, use `ggtqplotPD` to obtain plots based on `ggplot2` package. This function provides two types of curves: order `q` profile or reference `time` profile, which can be specified in the argument `profile`.

```{r, eval= FALSE}
ggtqplotPD(birds_Obs_q, profile = "q")
```

```{r,echo = FALSE, fig.width=7, fig.height=7, fig.align="center"}
ggtqplotPD(birds_Obs_q,profile = "q") + theme(text=element_text(size=14))
```

Second, observed reference time profile of PD for different diversity order `q`:

```{r,}
birds_Obs_q <- PhdObs(data = data.inc$data,nT = data.inc$nT, datatype = "incidence_raw", 
                         tree = data.inc$tree,q = c(0,1,2),
                         reftime = seq(0.01,82.8575,length.out = 40), type = "PD")

# only show part of the table, call View(birds_Obs_q) to see full table.
kable(head(birds_Obs_q))
```

To visualize the curves, use `profile = "time"` in `ggtqplotPD`.

```{r, eval= FALSE}
ggtqplotPD(birds_Obs_q, profile = "time")
```

```{r,echo = FALSE, fig.width=7, fig.height=7, fig.align="center"}
ggtqplotPD(birds_Obs_q,profile = "time") + theme(text=element_text(size=14))
```

### 4. `estimatePD()`

```{r,}
# leave argument "reftime" unsecified and it will be defaulted to the tree depth.
birds_estPD <- estimatePD(data = data.inc$data, nT = data.inc$nT, datatype = "incidence_raw",
                          tree = data.inc$tree, q = c(0,1,2), level = 0.9)
```

The `estimatePD()` function returns a table of the computed phylogenetic diversity (PD or meanPD) for specified/default diversity orders `q` and reference times for the user-specified values of sample coverage. The corresponding sample sizes and sample coverage values are also provided.

```{r,}
# only show part of the table, call View(birds_estPD) to see full table.
kable(birds_estPD)
```


<br><font size="4"><b>License</b></font>
-------------------
The PhD package is licensed under the GPLv3. To help refine `PhD`, your comments or feedbacks would be welcome (please send them to Anne Chao).

<br><font size="4"><b>How to cite</b></font>
-------------------
If you publish your work based on results from `PhD` (R package), please make reference to Chao et al. given in the following list.

<br><font size="4"><b>Reference</b></font>
-------------------
- Chao, A., Chiu C.-H. and Jost, L. (2010). Phylogenetic diversity measures based on Hill numbers. Philosophical Transactions of the Royal Society B., 365, 3599-3609.
- Chao, A., Chiu, C.-H., Hsieh, T. C., Davis, T., Nipperess, D., and Faith, D. (2015) Rarefaction and extrapolation of phylogenetic diversity. Methods in Ecology and Evolution, 6, 380-388.
- Hsieh, T. C. and Chao, A. (2017). Rarefaction and extrapolation: making fair comparison of abundance-sensitive phylogenetic diversity among multiple assemblages. Systematic Biology 66, 100-111.

